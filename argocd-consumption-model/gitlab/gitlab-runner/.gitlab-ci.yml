stages:
  - build
  - update

variables:
  IMAGE_TAG: "${CI_COMMIT_SHA}"
  REPO_NAME: "app"
  REGISTRY: "harbor-test.content.tmm.broadcom.lab"
  BUILDPLATFORM: "linux/amd64"
  BUILDKIT_PROGRESS: plain


# Build and push microservice images with BuildKit (daemonless)
build_image:
  stage: build
  before_script:
    - update-ca-certificates    

  tags: ["k8s"]
  script:
    - update-ca-certificates  
    
    # Docker auth for Harbor (BuildKit uses the standard Docker config)
    - mkdir -p "$HOME/.docker"
    - |
      cat > "$HOME/.docker/config.json" <<EOF
      {
        "auths": {
          "${REGISTRY}": {
            "username": "${CI_REGISTRY_USER}",
            "password": "${CI_REGISTRY_PASSWORD}"
          }
        }
      }
      EOF

    # Loop microservices and build with BuildKit (no Docker daemon needed)
    - |
      for dir in microservices-demo/src/*/; do
        service=$(basename "$dir")

        # Context + Dockerfile layout:
        # - cartservice: microservices-demo/src/cartservice/src/Dockerfile
        # - others:      microservices-demo/src/<service>/Dockerfile
        if [ "$service" = "cartservice" ]; then
          build_context="$dir/src"
        else
          build_context="$dir"
        fi

        dest="${REGISTRY}/${REPO_NAME}/${service}:${CI_COMMIT_SHA}"
        cache_repo="${REGISTRY}/${REPO_NAME}/${service}-cache"

        echo "Building ${service} -> ${dest}"

        # BuildKit daemonless build:
        /usr/bin/buildctl-daemonless.sh build \
          --frontend dockerfile.v0 \
          --local context="${build_context}" \
          --local dockerfile="${build_context}" \
          --opt filename=Dockerfile \
          --opt platform="${BUILDPLATFORM}" \
          --opt build-arg:BUILDPLATFORM="${BUILDPLATFORM}" \
          --import-cache type=registry,ref="${cache_repo}" \
          --export-cache type=registry,ref="${cache_repo}",mode=max \
          --output type=image,name="${dest}",push=true
      done

# Update Helm chart with the new image tag and push back to Git
update_helm_chart:
  stage: update
#  image:
#    name: harbor-test.content.tmm.broadcom.lab/library/buildkit-with-ca:v0.26.2
#    entrypoint: [""]
  tags: ["k8s"]
  before_script:
#    - cp /etc/ad-ca/* /usr/local/share/ca-certificates/
    - update-ca-certificates    
    - apt update
    - apt install -y git curl bash
    - curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/local/bin/yq
    - chmod +x /usr/local/bin/yq
    - git config --global user.email "gitlab_admin_977e50@example.com"
    - git config --global user.name "Administrator"
  script:
    - echo "Cloning Helm repo..."
    - git clone "https://Administrator:${HELM_REPO_PAT}@gitlab.content.tmm.broadcom.lab/root/app-code.git"
    - cd app-code
    - git checkout main
    - cd helm-charts
    - yq eval ".images.tag = \"${CI_COMMIT_SHA}\"" -i values.yaml
    - git add values.yaml
    - git commit -m "Update image tag to ${CI_COMMIT_SHA} for ${CI_PROJECT_NAME}" || echo "No changes to commit."
    - git push origin main