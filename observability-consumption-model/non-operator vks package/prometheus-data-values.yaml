# EXAMPLE file... edit to at least include certs (or remove cert lines to let cert-manager provide a certificate)

ingress:
  enabled: true
  prometheus_prefix: /
  prometheusServicePort: 80
  alertmanager_prefix: /alertmanager/
  alertmanagerServicePort: 80
  virtual_host_fqdn: prometheus.content.tmm.broadcom.lab
  tlsCertificate:
    ca.crt:
    tls.crt: |
      -----BEGIN CERTIFICATE-----
      [full chain cert]
      -----END CERTIFICATE-----
    tls.key: |
      -----BEGIN PRIVATE KEY-----
      [private key]
      -----END PRIVATE KEY-----    
        

namespace: tanzu-system-monitoring

alertmanager:
  pvc:
    storageClassName: vsan-esa-default-policy-raid5   

prometheus:
  pvc:
    storageClassName: vsan-esa-default-policy-raid5
  config:  
    prometheus_yml: |
      scrape_configs:
        # Scrape Services (endpoints)
        - job_name: 'kubernetes-services'
          kubernetes_sd_configs:
            - role: endpoints
          relabel_configs:
            # Only keep Services explicitly annotated
            - action: keep
              source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
              regex: "true"

            # Respect custom path/scheme/port from annotations
            - action: replace
              source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
              target_label: __metrics_path__
              regex: (.+)
            - action: replace
              source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
              target_label: __scheme__
              regex: (https?)
            - action: replace
              source_labels:
                [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
              regex: ([^:]+)(?::\d+)?;(\d+)
              replacement: $1:$2
              target_label: __address__

            # Nice target labels
            - action: replace
              source_labels: [__meta_kubernetes_namespace]
              target_label: namespace
            - action: replace
              source_labels: [__meta_kubernetes_service_name]
              target_label: service
            - action: replace
              source_labels: [__meta_kubernetes_pod_name]
              target_label: pod

        # Scrape Pods directly (when thereâ€™s no stable Service)
        - job_name: 'kubernetes-pods'
          kubernetes_sd_configs:
            - role: pod
          relabel_configs:
            - action: keep
              source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
              regex: "true"

            # (Optional) only Running pods
            - action: keep
              source_labels: [__meta_kubernetes_pod_phase]
              regex: Running

            # Respect custom path/scheme/port from annotations
            - action: replace
              source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
              target_label: __metrics_path__
              regex: (.+)
            - action: replace
              source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scheme]
              target_label: __scheme__
              regex: (https?)
            - action: replace
              source_labels:
                [__meta_kubernetes_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port]
              regex: (.+);(\d+)
              replacement: $1:$2
              target_label: __address__

            # Optional: ensure the annotated port actually exists on the pod
            # (helps avoid 404s if people fat-finger the port)
            - action: keep
              source_labels: [__meta_kubernetes_pod_container_port_number]
              regex: .+

            # Nice target labels
            - action: replace
              source_labels: [__meta_kubernetes_namespace]
              target_label: namespace
            - action: replace
              source_labels: [__meta_kubernetes_pod_name]
              target_label: pod
            - action: replace
              source_labels: [__meta_kubernetes_pod_label_app]
              target_label: app

       